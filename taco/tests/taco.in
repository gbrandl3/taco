#!/bin/sh

set_env() {
DSHOME=@abs_top_builddir@/tests/test@prefix@
srcdir=`grep '^srcdir' @abs_top_builddir@/tests/Makefile | cut -d' ' -f 3`
prefix=@abs_top_builddir@/tests/test@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
sbindir=@sbindir@
datadir=@datadir@
sysconfdir=@sysconfdir@
templatedir=@templatedir@
top_builddir=@abs_top_builddir@
testbindir=${top_builddir}/tests
appdefaultdir=@appdefaultdir@
localstatedir=@localstatedir@
infodir=@infodir@
libdir=${DESTDIR}@libdir@
LD_LIBRARY_PATH=@GCC_LIBRARY_PATH@:${libdir}:${LD_LIBRARY_PATH:+:}
export DSHOME LD_LIBRARY_PATH
export DBTABLES_CUSTOM=TEST,LONGTEST
}

unset NETHOST
# unset RES_BASE_DIR
set_env
if test $# -gt 0 ; then
	case $1 in 
		--version)	echo @PACKAGE_VERSION@;;
		install) if [ -d test ] ; then
				rm -rf test
			fi
			if { mkdir test; } ; then
				dc_destdir=$testbindir/test
				(cd $top_builddir && make DESTDIR=$dc_destdir install) >log 2>&1
				for i in $sysconfdir ; do
					(cd $i && mv tacoenv.sh t && sed -e 's%^prefix=.*$%prefix=@abs_top_builddir@/tests/test/@prefix@%' t > tacoenv.sh && rm -f t)
				done
				exit $?
			fi
			exit 1;;
		start)
			DESTDIR=$testbindir/test
			. $sysconfdir/tacoenv.sh 
			mkdir -p ${LOGPATH}
			set_env
			TACO_PATH=$sbindir
			export TACO_PATH
			$sbindir/taco.startup >>log 2>&1
			exit 0;;
		stop)
			. $sysconfdir/tacoenv.sh 
			$sbindir/taco.shutdown >>log 2>&1
			;;
		uninstall)
			dc_destdir=$testbindir/test
			rm -f ${localstatedir}/cache/taco/*
			rm -f ${localstatedir}/log/taco/*
			rm -f ${templatedir}/*
			rm -f ${infodir}/dir
			rm -f ${sbindir}/system/pipe/*
			(cd $top_builddir && make DESTDIR=$dc_destdir uninstall) >>log 2>&1
			dir=`echo $prefix | cut -d'/' -f 1`
			if [ -z "$dir" ] ; then
				dir=`echo $prefix | cut -d'/' -f 2`
			fi
			rm -rf ${dc_destdir}/$dir
			rm -rf ${dc_destdir}/@aclocaldir@
			dir=`echo $appdefaultdir|cut -d'/' -f1` 
			if [ -z "$dir" ] ; then
				dir=`echo $appdefaultdir|cut -d'/' -f2` 
			fi
			rm -rf ${dc_destdir}/$dir
			if test -d $dc_destdir ; then
				if { ! rmdir $dc_destdir 2>/dev/null; } ; then
					tmp=`find $dc_destdir -type f`
					if test x"$tmp" = x"${infodir}/dir" ;then
						rm -rf $dc_destdir
						exit $?
					fi
					if test x"$tmp" = x ; then
						rm -rf $dc_destdir
						exit $?
					fi
					exit 1
				fi
			fi
			exit 0 ;;
		unreg)
			. $sysconfdir/tacoenv.sh 
			set_env
			shift 1
			$sbindir/unreg $@ ;;

		dbm_server)
			. $sysconfdir/tacoenv.sh 
			set_env
			shift 1
			$sbindir/dbm_server dbm `uname -n|cut -f1 -d'.'` ;;
		ldd)
			. $sysconfdir/tacoenv.sh 
			set_env
			shift 1
			ldd $bindir/$1 ;;
		StartServer)
			. $sysconfdir/tacoenv.sh 
			set_env
			prog=$1
			shift 1
			LD_LIBRARY_PATH=${libdir}:${LD_LIBRARY_PATH} $sbindir/$prog $@;;
		local)
			shift 1
			prog=$1
			shift 1
			. $sysconfdir/tacoenv.sh 
			set_env
			LD_LIBRARY_PATH=${libdir}:${LD_LIBRARY_PATH} $prog $@ ;;
		*)
			prog=$1
			shift 1
			. $sysconfdir/tacoenv.sh 
			set_env
			LD_LIBRARY_PATH=${libdir}:${LD_LIBRARY_PATH} $bindir/$prog $@ ;;
	esac
else
	export LD_LIBRARY_PATH
	export sysconfdir
	export templatedir
fi
