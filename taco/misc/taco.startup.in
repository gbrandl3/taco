#!/bin/sh -v
#
# taco.startup : starts the TACO manager + database, if database does not
#		 exist it fills the database with the resource files using
#		 the db_fillup utility
#

environ()
{
# setup TACO environment variables
	prefix=${DSHOME:-@prefix@}
	exec_prefix=@exec_prefix@
	if test -f @sysconfdir@/tacoenv.sh ; then
		. @sysconfdir@/tacoenv.sh
	else
		. @templatedir@/tacoenv.sh
	fi

	echo "You are working on host $HOSTNAME machine -"
	echo ""
	echo "DSHOME 		= $DSHOME"
	echo "DBM_DIR		= $DBM_DIR"
	echo "RES_BASE_DIR	= $RES_BASE_DIR"
	echo "DBTABLES	= $DBTABLES"
	echo ""
	echo "PATH = $PATH"
}

dbase()
{
  	# fill the database if there are no
  	# database files present (names.pag)

  	if [ ! -r $DBM_DIR/names ]  
  	then
      		echo "calling db_fillup to fill database"
      		db_fillup 0
      		echo "dbm database fillup done"
  	fi
}

manager()
{
# first kill any Manager running and make sure program no. 100 is free
	killall Manager
	unreg 100

	if test "x$TACO_LOGGING" = "xyes" ; then
		taco_manager_flags="-log"
	fi
	if test "x$TACO_SECURITY" = "xyes" ; then
		taco_manager_flags="$taco_manager_flags -security"
	fi		
	taco_manager_flags="$taco_manager_flags -${TACO_DATABASE:-dbm}"

# now start the Manager 
	if ! test -d $LOGPATH ; then
		mkdir -p $LOGPATH
	fi
    	echo "starting the Manager ..."
    	Manager $taco_manager_flags 
	sleep 1
    	echo "Manager started"
}

#
#  Here is the heart of the script:
#
environ
dbase
manager
