Summary: TACO control system.
Name: @PACKAGE@
Version: @VERSION@
Release: @RPM_RELEASE@
License: GPL
Group: Utilities/TACO
Source: @PACKAGE@-@VERSION@.tar.bz2 
Prefix: %{_prefix}
Vendor: FRMII, TU München, FRG
Distribution:@DISTRIBUTION@
Requires: gdbm sqlite mysql python openmotif pyhton-numeric
BuildRequires: openmotif-devel gcc-c++ doxygen swig python-devel mysql-devel sqlite-devel tcl-devel python-numeric
Provides: taco
Url: http://www.sourceforge.net/projects/taco

%description
TACO is an object oriented control system originally developed at the European 
Synchrotron Radiation Facility to control accelerators and beamlines and data 
acquisition systems. 

At the ESRF (www.esrf.fr) TACO is used to control three accelerators - linear 
accelerator , booster synchrotron and storage ring, and over 30 beamlines. 

TACO is being used for instrument control for the new  neutron source FRM-II 
(www.frm2.tum.de) in Garching-Munich. 

TACO has been applied to telescope control at the 26m radio telescope at the 
Hartebeesthoek Radio Astronomy Observatory (www.hartroa.ac.za). 

TACO is very scalable and can be used for simple single device laboratory like 
setups with only a few devices or for a big installation comprising thousands of 
devices. TACO is a cheap and simple solution for doing distributed home automation. 

TACO is available free of charge without warranties. 

TACO is object oriented because it treats ALL (physical and logical) control 
points in a control system as objects in a distributed environment. All actions 
are implemented in classes. New classes can be constructed out of existing classes 
in a hierarchical manner thereby ensuring a high-level of software reuse. Classes 
can be written in C++, in C (using a methodology called Objects in C), in Python 
or in LabView (using G). 

TACO has been designed to be portable and runs on a large number of platforms (e.g. 
Linux, Solaris, BSD, Mac OS X, HP-UX, Win32, OS9). 

%prep
%setup -n @PACKAGE@-@VERSION@

%build
./configure --enable-fast-install=yes --enable-greta --enable-xdevmenu --prefix=%_prefix --enable-ext
make 

%install
make install-strip
make "DESTDIR=$PWD/tmp-install-dir" install
# %makeinstall
find tmp-install-dir -regex ".*%{_libdir}/.*" -a -not -type d | sed -e 's/^tmp-install-dir//' > @PACKAGE@.txt
find tmp-install-dir -regex ".*%{_includedir}/.*" -a -not -type d | sed -e 's/^tmp-install-dir//' >> @PACKAGE@.txt
cp @PACKAGE@.txt /tmp

%clean
if test "$PWD" = "${PWD%/*}/@PACKAGE@-@VERSION@" ; then
	rm -rf "$PWD"
else
	echo "error: unexpected build directory: $PWD" ; exit 1
fi
       
%post
prefix="$RPM_INSTALL_PREFIX"
mkdir -p "%_datadir/taco/dbase/dbm"
mkdir -p "%_datadir/taco/dbase/res/TEST"

# Adjust some paths
if test "x$prefix" != x%prefix ; then
	cd %prefix
	for i in etc/taco.shutdown \
		etc/taco.startup \
		etc/tacoenv.sh \
		etc/tacoenv.csh \
		share/taco/templates/tacoenv.sh
	do
		mv $i tmp.sed
		sed -e "s|%prefix|$prefix|" tmp.sed > $i
	done
	for i in lib/*.la \
		share/taco/templates/taco
	do
		mv $i tmp.sed
		sed -e "s|%prefix|$prefix|" tmp.sed > $i
		chmod 0755 $i
	done
	rm -f tmp.sed

	SHL_EXT=`(. %_libdir/python%{py_ver}/site-packages/Server.la ; echo ${library_names} | cut -f3 -d' ' | cut -f2 -d'.')` ; 
	rm -f %_libdir/python%{py_ver}/site-packages/Taco.${SHL_EXT} && ln -s Server.${SHL_EXT} %_libdir/python%{py_ver}/site-packages/Taco.${SHL_EXT}
fi

# Update the linker cache
/sbin/ldconfig -n %_libdir

# Install runlevel control script
test -f %_sysconfdir/tacoenv.sh || install -m 0644 "%_datadir/taco/templates/tacoenv.sh" %_sysconfdir

# Install TACO environment file
if test -d /etc/init.d ; then
	initdir=/etc/init.d
elif test -d /sbin/init.d ; then
	initdir=/sbin/init.d
elif test -d /etc/rc.d ; then
	initdir=/etc/rc.d
else
	echo "error: cannot find init directory"
	exit 1
fi
if ! test -f "$initdir/taco" ; then
	taco_rc_file="%_datadir/taco/templates/taco"
	if test -f /etc/SuSE-release ; then
		case `grep VERSION /etc/SuSE-release` in
			'VERSION = 7.'*)
				sed -e 's/\$portmap/portmap/' "$taco_rc_file" > "$taco_rc_file.sed"
				mv "$taco_rc_file.sed" "$taco_rc_file"
				chmod 0755 "$taco_rc_file"
				;;
		esac
	fi
	install "$taco_rc_file" "$initdir"
fi
echo "The automatic installation is complete."
echo "You should read the file '%_datadir/doc/index.html' now."

%preun
SHL_EXT=`(. %_libdir/python%{py_ver}/site-packages/Server.la ; echo ${library_names} | cut -f3 -d' ' | cut -f2 -d'.')` ; 
rm -f %_libdir/python%{py_ver}/site-packages/Taco.${SHL_EXT}

# Delete TACO services startup at the final erase
if test "x$1" = x0 ; then
	if test -e /sbin/chkconfig ; then
		/sbin/chkconfig --del taco
	elif test -e /sbin/insserv ; then
		/sbin/insserv -r taco
	else
		echo "error: cannot find program to remove runlevel control script"
		exit 1
	fi
fi

%files -f @PACKAGE@.txt
%defattr(-,root,root)
%_datadir/taco/templates/taco
%config %_sysconfdir/tacoenv.sh
%config %_sysconfdir/tacoenv.csh
%doc %_infodir/gdbm.info
# %doc INSTALL doc/TACO.pdf doc/README doc/index.html
%_bindir/dc_del
%_bindir/dc_dels
%_bindir/dc_devall
%_bindir/dc_devinfo
%_bindir/dc_hash
%_bindir/dc_info
%_bindir/dc_init
%_bindir/dc_inits
%_bindir/dc_mem
%_bindir/dc_mfree
%_bindir/dc_mfrees
%_bindir/dc_patch
%_bindir/conv2gdbm
%_bindir/db_devicetree
%_bindir/db_fillup
%_bindir/db_fillup2
%_bindir/db_update
%_bindir/db_read
%_bindir/db_info
%_bindir/db_initcache
%_bindir/db_devinfo
%_bindir/db_devdel
%_bindir/db_servdel
%_bindir/db_servinfo
%_bindir/db_servunreg
%_bindir/db_devres
%_bindir/db_resdel
%_sbindir/dcwr_alo
%_sbindir/dcrd_alo
%_sbindir/StartServer
%_sbindir/Manager
%_sbindir/unreg
%_sbindir/MessageServer
%_sbindir/dbm_server
%config(noreplace) %_sbindir/taco.shutdown
%config(noreplace) %_sbindir/taco.startup
%config(noreplace) %_datadir/taco/dbase/res/SEC/sec_auth.res
%config %_datadir/taco/dbase/res/CMDS/dev_cmds.res
%config %_datadir/taco/dbase/res/ERROR/dev_errors.res
%config %_datadir/taco/dbase/res/ERROR/db_errors.res
%config %_datadir/taco/dbase/res/TEST/python.res

%package devel
Summary: TACO devel
Group: Utilities/TACO/devel
Prefix: %{_prefix}
Provides: taco-devel

%description devel

%files devel
%_sbindir/taco-config
%_datadir/aclocal/extra.m4
%_datadir/aclocal/findfile.m4
%_datadir/aclocal/python.m4
%_datadir/aclocal/qt.m4
%_datadir/aclocal/rpm.m4
%_datadir/aclocal/swig.m4
%_datadir/aclocal/taco.m4

%package x-apps
Summary: TACO control system X11 applications.
Group: Utilities/TACO/X11
Prefix: %{_prefix}
Provides: taco-x-apps

%description x-apps

%files x-apps
%defattr(-,root,root)
%_bindir/greta
%_bindir/xdevmenu
%_sbindir/S_Alarm
@appdefaultdir@/GReta
@appdefaultdir@/XDevmenu

%changelog
* Mon Oct 29 2007 Jens Krüger <jens.krueger@frm2.tum.de>
- Change some entries for the SuSE online build system
* Wed Jun 02 2004 Jens Krüger <jens.krueger@frm2.tum.de>
- Change the pathes for the autotool macros
- remove the 'make uninstall' in the 'clean' section
* Wed May 19 2004 Jens Krüger <jens.krueger@frm2.tum.de>
- Change the variables from autotools to rpm
