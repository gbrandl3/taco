Summary: TACO control system.
Name: @PACKAGE@
Version: @VERSION@
Release: @RPM_RELEASE@
Copyright: GPL
Group: Utilities/TACO
Source: @PACKAGE@-@VERSION@.tar.gz 
Prefix: @prefix@
Vendor: FRMII, TU München, FRG
Requires: gdbm
Provides: taco

%description

%prep
%setup -n @PACKAGE@-@VERSION@

%build
export DSHOME=@prefix@
./configure --enable-fast-install=yes --enable-greta --enable-xdevmenu --with-motif=/usr/X11R6/LessTif/Motif1.2 "--prefix=$DSHOME"
make 

%install
export DSHOME=@prefix@
make install-strip
make "DESTDIR=$PWD/tmp-install-dir" install
find tmp-install-dir -regex ".*$DSHOME/lib/.*" -a -not -type d | sed -e 's/^tmp-install-dir//' > @PACKAGE@.txt
find tmp-install-dir -regex ".*$DSHOME/include/.*" -a -not -type d | sed -e 's/^tmp-install-dir//' >> @PACKAGE@.txt

%clean
make uninstall
if test "$PWD" = "${PWD%/*}/@PACKAGE@-@VERSION@" ; then
	rm -rf "$PWD"
else
	echo "error: unexpected build directory: $PWD" ; exit 1
fi
       
%post
export DSHOME="$RPM_INSTALL_PREFIX"
mkdir -p "$DSHOME/dbase/dbm"
mkdir -p "$DSHOME/dbase/res/TEST"

# Adjust some paths
if test "x$DSHOME" != x@prefix@ ; then
	cd "$DSHOME"
	for i in etc/.taco.csh \
		etc/.taco_env \
		etc/taco.shutdown \
		etc/taco.startup \
		etc/taco.startup.sec \
		templates/taco/tacoenv.sh
	do
		mv $i tmp.sed
		sed -e "s%@prefix@%$DSHOME%" tmp.sed > $i
	done
	for i in lib/@taco_install_path@/libTACOMySQL.la \
		lib/@taco_install_path@/libTACOndbm.la \
		lib/@taco_install_path@/libascapi.la \
		lib/@taco_install_path@/libdataport.la \
		lib/@taco_install_path@/libdbapi.la \
		lib/@taco_install_path@/libdcapi.la \
		lib/@taco_install_path@/libdcmem.la \
		lib/@taco_install_path@/libdsapi.la \
		lib/@taco_install_path@/libdsapig++.la \
		lib/@taco_install_path@/libdsxdr.la \
		lib/@taco_install_path@/libdsxdr_all.la \
		lib/@taco_install_path@/libtacoapi.la \
		lib/@taco_install_path@/libtacoapig++.la \
		lib/@taco_install_path@/libtcapi.la \
		templates/taco/taco
	do
		mv $i tmp.sed
		sed -e "s%@prefix@%$DSHOME%" tmp.sed > $i
		chmod 0755 $i
	done
	rm -f tmp.sed
fi

# Update the linker cache
cd "$DSHOME/lib/@taco_install_path@
/sbin/ldconfig -n

# Install runlevel control script
test -f /etc/tacoenv.sh || install -m 0644 "$DSHOME/templates/taco/tacoenv.sh" /etc

# Install TACO environment file
if test -d /etc/init.d ; then
	initdir=/etc/init.d
elif test -d /sbin/init.d ; then
	initdir=/sbin/init.d
elif test -d /etc/rc.d ; then
	initdir=/etc/rc.d
else
	echo "error: cannot find init directory"
	exit 1
fi
if ! test -f "$initdir/taco" ; then
	taco_rc_file="$DSHOME/templates/taco/taco"
	if test -f /etc/SuSE-release ; then
		case `grep VERSION /etc/SuSE-release` in
			'VERSION = 7.'*)
				sed -e 's/\$portmap/portmap/' "$taco_rc_file" > "$taco_rc_file.sed"
				mv "$taco_rc_file.sed" "$taco_rc_file"
				chmod 0755 "$taco_rc_file"
				;;
		esac
	fi
	install "$taco_rc_file" "$initdir"
fi
echo "The automatic installation is complete."
echo "You should read the file '$DSHOME/doc/index.html' now."

%preun
# Delete TACO services startup at the final erase
if test "x$1" = x0 ; then
	if test -e /sbin/chkconfig ; then
		/sbin/chkconfig --del taco
	elif test -e /sbin/insserv ; then
		/sbin/insserv -r taco
	else
		echo "error: cannot find program to remove runlevel control script"
		exit 1
	fi
fi

%files -f @PACKAGE@.txt
%defattr(-,root,root)
@prefix@/doc/index.html
@prefix@/templates/taco/taco
@prefix@/templates/taco/tacoenv.sh
%config(noreplace) @prefix@/etc/.taco_env
%config(noreplace) @prefix@/etc/.taco.csh
%config(noreplace) @prefix@/etc/taco.shutdown
%config(noreplace) @prefix@/etc/taco.startup
%config(noreplace) @prefix@/etc/taco.startup.sec
%config @prefix@/dbase/res/SYS/README
%config @prefix@/dbase/res/SEC/README
%config(noreplace) @prefix@/dbase/res/SEC/sec_frm.res
%config @prefix@/dbase/res/CMDS/README
%config @prefix@/dbase/res/CMDS/dev_cmds.res
%config @prefix@/dbase/res/NAMES/README
%config @prefix@/dbase/res/PS_NAMES/README
%config @prefix@/dbase/res/ERROR/README
%config @prefix@/dbase/res/ERROR/dev_errors.res
%config @prefix@/dbase/res/CLASS/README
%config @prefix@/dbase/res/CLASS/Inst_verify.res
%config @prefix@/dbase/res/EVENTS/README
%doc INSTALL doc/TACO.pdf doc/README
@prefix@/bin/@taco_install_path@/db_fillup
@prefix@/bin/@taco_install_path@/db_update
@prefix@/bin/@taco_install_path@/db_read
@prefix@/bin/@taco_install_path@/db_info
@prefix@/bin/@taco_install_path@/db_initcache
@prefix@/bin/@taco_install_path@/db_devinfo
@prefix@/bin/@taco_install_path@/db_devdel
@prefix@/bin/@taco_install_path@/db_servdel
@prefix@/bin/@taco_install_path@/db_servinfo
@prefix@/bin/@taco_install_path@/db_servunreg
@prefix@/bin/@taco_install_path@/db_devres
@prefix@/bin/@taco_install_path@/db_resdel
@prefix@/system/bin/@taco_install_path@/Manager
@prefix@/system/bin/@taco_install_path@/unreg
@prefix@/system/bin/@taco_install_path@/MessageServer
@prefix@/system/bin/@taco_install_path@/dcwr_alo
@prefix@/system/bin/@taco_install_path@/dcrd_alo
@prefix@/system/bin/@taco_install_path@/dbm_server

%package x-apps
Summary: TACO control system X11 applications.
Group: Utilities/TACO/X11
Prefix: @prefix@
Provides: taco-x-apps

%description x-apps

%files x-apps
%defattr(-,root,root)
@prefix@/bin/@taco_install_path@/greta
@prefix@/bin/@taco_install_path@/xdevmenu
@prefix@/bin/@taco_install_path@/S_Alarm
@appdefaultdir@/GReta
@appdefaultdir@/XDevmenu

